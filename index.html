<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Happy Birthday My Love üíñ</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --rose-gold: #b76e79;
  --champagne: #f7e7ce;
  --gold: #d4af37;
  --rose: #e8b4b8;
  --deep-rose: #8b5a5f;
}

* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

body{
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #2a1a1f 0%, #4a2f35 25%, #6b4248 50%, #4a2f35 75%, #2a1a1f 100%);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  color: white;
  font-family: 'Poppins', sans-serif;
  overflow: hidden;
  height: 100vh;
  position: relative;
  overscroll-behavior: none;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Optimized particles for mobile */
.particle {
  position: absolute;
  width: 3px;
  height: 3px;
  background: radial-gradient(circle, var(--champagne), transparent);
  border-radius: 50%;
  animation: float 10s infinite ease-in-out;
  opacity: 0.4;
  will-change: transform;
}

@keyframes float {
  0%, 100% { transform: translate3d(0, 0, 0); }
  25% { transform: translate3d(10px, -30px, 0); }
  50% { transform: translate3d(-10px, -60px, 0); }
  75% { transform: translate3d(5px, -30px, 0); }
}

#quest-container{
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  height: 100%;
  text-align: center;
  position: relative;
  z-index: 2;
  padding: 15px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.step{
  display: none;
  max-width: 100%;
  width: 100%;
  padding: 15px;
  animation: fadeSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  margin: auto;
}

.step.active{display: flex; flex-direction: column; justify-content: center; align-items: center;}

@keyframes fadeSlideIn{
  from{
    opacity: 0;
    transform: translate3d(0, 30px, 0) scale(0.95);
  }
  to{
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(1);
  }
}

.step h2 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.5rem, 4.5vw, 2.5rem);
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--champagne), var(--rose-gold), var(--gold));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 20px rgba(183, 110, 121, 0.3));
  animation: textGlow 3s ease-in-out infinite;
  line-height: 1.3;
  padding: 0 10px;
}

@keyframes textGlow {
  0%, 100% { filter: drop-shadow(0 0 20px rgba(183, 110, 121, 0.3)); }
  50% { filter: drop-shadow(0 0 30px rgba(183, 110, 121, 0.5)); }
}

.step p {
  font-size: clamp(0.95rem, 2.8vw, 1.1rem);
  color: var(--champagne);
  line-height: 1.5;
  margin: 8px 0;
  opacity: 0.95;
  padding: 0 10px;
}

.heart-main{
  font-size: clamp(90px, 22vw, 140px);
  cursor: pointer;
  animation: heartPulse 2s infinite ease-in-out;
  filter: drop-shadow(0 0 30px var(--rose-gold)) drop-shadow(0 0 60px rgba(183, 110, 121, 0.4));
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-block;
  margin: 25px 0;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}

.heart-main:active {
  transform: scale(0.9);
}

@keyframes heartPulse{
  0%, 100%{transform: scale(1)}
  25%{transform: scale(1.08) rotate(-3deg)}
  75%{transform: scale(1.05) rotate(3deg)}
}

.hint{
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  color: var(--rose);
  font-style: italic;
  margin-top: 12px;
  animation: hintGlow 2s ease-in-out infinite;
  padding: 0 15px;
}

@keyframes hintGlow {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

/* Mobile-optimized slider */
#dateValue {
  font-size: clamp(1.4rem, 4.5vw, 2rem);
  color: var(--gold);
  font-weight: 600;
  margin: 18px 0;
  text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
  font-family: 'Playfair Display', serif;
  min-height: 35px;
}

input[type="range"] {
  width: 100%;
  max-width: 320px;
  height: 10px;
  background: linear-gradient(90deg, rgba(247, 231, 206, 0.2), rgba(183, 110, 121, 0.4));
  border-radius: 10px;
  outline: none;
  margin-top: 18px;
  appearance: none;
  -webkit-appearance: none;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(247, 231, 206, 0.2);
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 26px;
  height: 26px;
  background: linear-gradient(135deg, var(--rose-gold), var(--champagne));
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 20px var(--rose-gold), 0 2px 10px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
  border: 2px solid white;
}

input[type="range"]:active::-webkit-slider-thumb {
  transform: scale(1.3);
  box-shadow: 0 0 30px var(--rose-gold);
}

input[type="range"]::-moz-range-thumb {
  width: 26px;
  height: 26px;
  background: linear-gradient(135deg, var(--rose-gold), var(--champagne));
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 20px var(--rose-gold);
  border: 2px solid white;
}

/* Mobile-optimized stars */
.star{
  position: absolute;
  font-size: clamp(30px, 7.5vw, 40px);
  cursor: pointer;
  animation: starTwinkle 2.5s infinite ease-in-out;
  filter: drop-shadow(0 0 12px var(--gold));
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  user-select: none;
  -webkit-user-select: none;
  padding: 8px;
  touch-action: manipulation;
}

.star:active {
  transform: scale(1.4) rotate(180deg);
  filter: drop-shadow(0 0 25px var(--gold));
}

@keyframes starTwinkle{
  0%, 100%{opacity: 0.6; transform: scale(1) rotate(0deg)}
  50%{opacity: 1; transform: scale(1.15) rotate(180deg)}
}

#star-field {
  position: relative;
  height: 55vh;
  max-height: 380px;
  width: 100%;
  max-width: 400px;
  margin-top: 18px;
  background: radial-gradient(ellipse at center, rgba(183, 110, 121, 0.15), transparent);
  border-radius: 20px;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(247, 231, 206, 0.15);
}

/* Mobile-optimized button */
#final-btn{
  padding: 16px 38px;
  border-radius: 50px;
  border: none;
  background: linear-gradient(135deg, var(--champagne), var(--rose-gold));
  color: var(--deep-rose);
  font-weight: 700;
  font-size: clamp(0.95rem, 2.8vw, 1.1rem);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 30px rgba(183, 110, 121, 0.4);
  position: relative;
  margin-top: 18px;
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  will-change: transform;
  min-width: 180px;
}

#final-btn:active {
  transform: translateY(-2px) scale(0.98);
  box-shadow: 0 12px 40px rgba(183, 110, 121, 0.6);
}

#catch-msg {
  margin-top: 18px;
  font-size: clamp(0.95rem, 2.8vw, 1.1rem);
  color: var(--gold);
  font-weight: 600;
  min-height: 28px;
}

/* Mobile-optimized modal */
#memoryModal{
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: modalFadeIn 0.3s ease;
  padding: 20px;
}

@keyframes modalFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.memory-box{
  background: linear-gradient(135deg, 
    rgba(247, 231, 206, 0.15), 
    rgba(183, 110, 121, 0.2)
  );
  backdrop-filter: blur(20px);
  border: 2px solid rgba(247, 231, 206, 0.3);
  border-radius: 25px;
  padding: 22px;
  max-width: 90%;
  width: 100%;
  max-width: 380px;
  text-align: center;
  color: white;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translate3d(0, 50px, 0) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0) scale(1);
  }
}

.memory-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(247, 231, 206, 0.1), transparent 70%);
  animation: shimmer 4s infinite;
  pointer-events: none;
}

@keyframes shimmer {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.memory-box img{
  width: 100%;
  max-height: 280px;
  object-fit: cover;
  border-radius: 15px;
  margin-bottom: 18px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  border: 3px solid rgba(247, 231, 206, 0.3);
  position: relative;
  z-index: 1;
}

.memory-box p {
  font-size: clamp(0.95rem, 2.8vw, 1.1rem);
  line-height: 1.5;
  color: var(--champagne);
  font-style: italic;
  position: relative;
  z-index: 1;
  margin: 12px 0;
}

.memory-box button{
  margin-top: 18px;
  padding: 12px 32px;
  border: none;
  border-radius: 30px;
  background: linear-gradient(135deg, var(--rose-gold), var(--gold));
  color: white;
  font-weight: 600;
  font-size: clamp(0.9rem, 2.8vw, 1.05rem);
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 5px 20px rgba(183, 110, 121, 0.4);
  position: relative;
  z-index: 1;
  touch-action: manipulation;
}

.memory-box button:active {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(183, 110, 121, 0.6);
}

/* Fully responsive final card */
.final-card {
  background: linear-gradient(135deg, 
    rgba(247, 231, 206, 0.95), 
    rgba(232, 180, 184, 0.9)
  );
  backdrop-filter: blur(20px);
  padding: 22px 18px 18px;
  border-radius: 22px;
  color: var(--deep-rose);
  box-shadow: 
    0 25px 80px rgba(183, 110, 121, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  border: 2px solid rgba(255, 255, 255, 0.5);
  animation: finalReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 100%;
  width: 100%;
  max-width: 420px;
  overflow-y: auto;
  max-height: 85vh;
  -webkit-overflow-scrolling: touch;
  display: flex;
  flex-direction: column;
  align-items: center;
}

@keyframes finalReveal {
  from {
    opacity: 0;
    transform: scale(0.8) rotateY(90deg);
  }
  to {
    opacity: 1;
    transform: scale(1) rotateY(0deg);
  }
}

.final-card img {
  width: 100%;
  max-height: 220px;
  height: auto;
  object-fit: cover;
  border-radius: 15px;
  margin-bottom: 12px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  border: 3px solid rgba(255, 255, 255, 0.8);
}

.final-card h2 {
  color: var(--rose-gold);
  margin: 8px 0;
  font-size: clamp(1.3rem, 4.2vw, 2rem);
  line-height: 1.3;
  text-align: center;
}

.final-card p {
  color: var(--deep-rose);
  font-size: clamp(0.9rem, 2.6vw, 1.05rem);
  line-height: 1.5;
  margin: 8px 0;
  text-align: center;
  padding: 0 5px;
}

/* Replay button */
#replayBtn {
  margin-top: 15px;
  margin-bottom: 8px;
  padding: 11px 28px;
  border: 2px solid var(--rose-gold);
  border-radius: 28px;
  background: transparent;
  color: var(--rose-gold);
  font-weight: 600;
  font-size: clamp(0.88rem, 2.6vw, 1rem);
  cursor: pointer;
  transition: all 0.3s ease;
  touch-action: manipulation;
  width: auto;
  max-width: 220px;
  display: inline-block;
}

#replayBtn:active {
  background: var(--rose-gold);
  color: white;
  transform: scale(0.95);
}

/* Optimized sparkle */
.sparkle {
  position: fixed;
  width: 6px;
  height: 6px;
  background: radial-gradient(circle, var(--champagne), var(--gold));
  border-radius: 50%;
  pointer-events: none;
  animation: sparkleFade 0.8s ease-out forwards;
  z-index: 999;
  box-shadow: 0 0 8px var(--gold);
  will-change: transform, opacity;
}

@keyframes sparkleFade {
  0% { 
    transform: translate3d(0, 0, 0) scale(1); 
    opacity: 1; 
  }
  100% { 
    transform: translate3d(0, -25px, 0) scale(0); 
    opacity: 0; 
  }
}

/* Floating hearts - reduced for mobile */
.floating-heart {
  position: absolute;
  font-size: 15px;
  opacity: 0.12;
  animation: floatHeart 18s infinite ease-in-out;
  pointer-events: none;
  will-change: transform;
}

@keyframes floatHeart {
  0% {
    transform: translate3d(0, 100vh, 0) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 0.12;
  }
  90% {
    opacity: 0.12;
  }
  100% {
    transform: translate3d(0, -100px, 0) rotate(360deg);
    opacity: 0;
  }
}

/* Image placeholder */
.img-placeholder {
  background: linear-gradient(135deg, var(--rose), var(--champagne));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  color: white;
  min-height: 180px;
  border-radius: 15px;
}

/* Responsive adjustments for very small screens */
@media (max-height: 600px) {
  .step h2 {
    font-size: clamp(1.3rem, 4vw, 2rem);
    margin-bottom: 8px;
  }
  
  .heart-main {
    font-size: clamp(80px, 20vw, 120px);
    margin: 15px 0;
  }
  
  #star-field {
    height: 50vh;
    max-height: 300px;
  }
  
  .final-card {
    padding: 18px 15px 15px;
    max-height: 90vh;
  }
  
  .final-card img {
    max-height: 180px;
  }
}

/* Landscape mode adjustments */
@media (orientation: landscape) and (max-height: 500px) {
  #quest-container {
    padding: 10px;
  }
  
  .step {
    padding: 10px;
  }
  
  .step h2 {
    font-size: clamp(1.2rem, 3.5vw, 1.8rem);
    margin-bottom: 6px;
  }
  
  .step p {
    font-size: clamp(0.85rem, 2.5vw, 1rem);
    margin: 6px 0;
  }
  
  .heart-main {
    font-size: clamp(70px, 18vw, 100px);
    margin: 12px 0;
  }
  
  #star-field {
    height: 65vh;
    max-height: 280px;
  }
  
  .final-card {
    max-height: 92vh;
    padding: 15px 12px 12px;
  }
  
  .final-card img {
    max-height: 150px;
  }
}

</style>
</head>

<body>

<!-- Audio element (user will need to tap to play on mobile) -->
<audio id="bg-music" loop>
  <source src="happyBirthday.mp3" type="audio/mpeg">
</audio>

<div id="quest-container">

<!-- STEP 1 -->
<div id="step1" class="step active">
  <h2>Hello Sudu Manika</h2>
  <p>Come with me to your birthday party‚Ä¶</p>
  <div class="heart-main" ontouchstart="handleHeartTap(event)" onclick="handleHeartTap(event)">‚ù§Ô∏è</div>
  <p class="hint">Touch my heart to enter our little birthday party‚Ä¶</p>
</div>

<!-- STEP 2 -->
<div id="step2" class="step">
  <h2>Hey chief guest ! </h2>
  <p>Slide to the month this little angel came to this beautifull world</p>
  <div id="dateValue">January</div>
  <input type="range" min="1" max="12" value="1" oninput="updateSlider(this.value)" ontouchstart="handleSliderTouch()">
  <p class="hint">Cut the ribbon to our little party‚Ä¶</p>
</div>

<!-- STEP 3 -->
<div id="step3" class="step">
  <h2>Is it true that you love flowers ?  </h2>
  <p>See your sweetest moments that caught my eyes, Each star holds a moment of us‚Ä¶ tap them all üí´</p>
  <div id="star-field">
    <span class="star" ontouchstart="handleStarTap(0, event)" onclick="openMemory(0)">‚≠ê</span>
    <span class="star" ontouchstart="handleStarTap(1, event)" onclick="openMemory(1)">‚≠ê</span>
    <span class="star" ontouchstart="handleStarTap(2, event)" onclick="openMemory(2)">‚≠ê</span>
    <span class="star" ontouchstart="handleStarTap(3, event)" onclick="openMemory(3)">‚≠ê</span>
    <span class="star" ontouchstart="handleStarTap(4, event)" onclick="openMemory(4)">‚≠ê</span>
  </div>
  <p id="star-hint" class="hint">Open every star to unlock your birthday gift‚Ä¶</p>
</div>

<!-- STEP 4 -->
<div id="step4" class="step">
  <h2>üíò Catch My Love</h2>
  <p>My heart belongs to you‚Ä¶ but can you catch it?</p>
  <button id="final-btn" ontouchstart="handleButtonTouch(event)" onclick="handleButtonClick(event)">Catch Me ‚ù§Ô∏è</button>
  <p id="catch-msg" class="hint"></p>
</div>

<!-- STEP 5 -->
<div id="step5" class="step">
  <div class="final-card">
    <!-- REPLACE THIS SRC WITH YOUR PHOTO -->
    <img src="final-photo.jpg" alt="Birthday Girl" onerror="this.outerHTML='<div class=\'img-placeholder\'>üíë</div>'">
    <h2>Happy Birthday My Love! üéÇ</h2>
    <p>Every day with you is an adventure, every moment a treasure. You make ordinary days magical and my heart overflow with joy. Wishing you the happiest birthday pretty girl üíñ‚ú®</p>
    <p style="margin-top:12px; font-style:italic; color: var(--rose-gold); font-weight: 600;">Today is yours only, Cheers to your 24th darling. much love üéâüíï</p>
    <button id="replayBtn" onclick="replayQuest()">Replay Our Story üîÑ</button>
  </div>
</div>

</div>

<!-- MEMORY MODAL -->
<div id="memoryModal" ontouchstart="handleModalTouch(event)">
  <div class="memory-box">
    <!-- Images will load here -->
    <img id="memoryImg" alt="Memory">
    <p id="memoryText"></p>
    <button ontouchstart="handleCloseTouch(event)" onclick="closeMemory()">Close üíñ</button>
  </div>
</div>

<script>
const correctMonth = 2; // February
let openedStars = new Set();
let dodgeCount = 0;
let buttonDodging = true;

// Memory data - REPLACE IMAGE PATHS WITH YOUR PHOTOS
const memories = [
 {img: "memory1.jpg", text: "Your favourite place that will give peace to you ‚ú®"},
 {img: "memory2.jpg", text: "The prettiest girl in the highest place of the city of dreams ‚ú®"},
 {img: "memory3.jpg", text: "The place you took me to heal ourselves üåÖ"},
 {img: "memory4.jpg", text: "You were always my flower girl üåπ"},
 {img: "memory5.jpg", text: "Every adventure with you is my favorite üíï"}
];

// Performance optimization for mobile
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const particleCount = isMobile ? 15 : 25;

// Create optimized particles
function createParticles() {
  for(let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.top = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 10 + 's';
    particle.style.animationDuration = (10 + Math.random() * 5) + 's';
    document.body.appendChild(particle);
  }
}

// Create floating hearts
function createFloatingHearts() {
  const heartInterval = isMobile ? 4000 : 3000;
  setInterval(() => {
    const heart = document.createElement('div');
    heart.className = 'floating-heart';
    heart.innerText = 'üíï';
    heart.style.left = Math.random() * 100 + '%';
    heart.style.animationDuration = (15 + Math.random() * 8) + 's';
    document.body.appendChild(heart);
    
    setTimeout(() => heart.remove(), 25000);
  }, heartInterval);
}

createParticles();
createFloatingHearts();

// Position stars for mobile
function positionStars(){
 const positions = [
   {left: '10%', top: '15%'},
   {left: '70%', top: '10%'},
   {left: '50%', top: '40%'},
   {left: '20%', top: '70%'},
   {left: '75%', top: '65%'}
 ];
 
 document.querySelectorAll('.star').forEach((s, i) => {
   s.style.left = positions[i].left;
   s.style.top = positions[i].top;
   s.style.animationDelay = (i * 0.3) + 's';
 });
}
positionStars();

// Smooth step transitions
function nextStep(n, e){
 if(e) e.preventDefault();
 
 const current = document.querySelector('.step.active');
 if(current) {
   current.style.animation = 'fadeSlideOut 0.4s ease';
 }
 
 setTimeout(() => {
   document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
   const next = document.getElementById('step' + n);
   next.classList.add('active');
   next.style.animation = 'fadeSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
 }, 250);
}

// Touch handlers
function handleHeartTap(e) {
  e.preventDefault();
  createSparkle(e.touches ? e.touches[0].clientX : e.clientX, e.touches ? e.touches[0].clientY : e.clientY);
  setTimeout(() => nextStep(2, e), 300);
}

function handleSliderTouch() {
  // Haptic feedback if available
  if(navigator.vibrate) {
    navigator.vibrate(10);
  }
}

function updateSlider(v){
 const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
 dateValue.innerText = months[v-1];
 
 // Sparkle effect
 if(Math.random() > 0.6) {
   const slider = document.querySelector('input[type="range"]');
   const rect = slider.getBoundingClientRect();
   createSparkle(rect.left + (v/12) * rect.width, rect.top);
 }
 
 if(+v === correctMonth) {
   if(navigator.vibrate) navigator.vibrate([50, 30, 50]);
   
   confetti({
     particleCount: isMobile ? 40 : 60,
     spread: 60,
     origin: { y: 0.5 },
     colors: ['#b76e79', '#f7e7ce', '#d4af37']
   });
   setTimeout(() => nextStep(3), 1000);
 }
}

function handleStarTap(i, e) {
  e.preventDefault();
  if(navigator.vibrate) navigator.vibrate(20);
  openMemory(i);
}

function openMemory(i){
 const memory = memories[i];
 memoryImg.src = memory.img;
 
 // Handle image load errors
 memoryImg.onerror = function() {
   this.outerHTML = '<div class="img-placeholder">üì∑</div>';
 };
 
 memoryText.innerText = memory.text;
 memoryModal.style.display = "flex";
 
 // Confetti effect
 confetti({
   particleCount: isMobile ? 25 : 35,
   spread: 50,
   origin: { x: 0.5, y: 0.5 },
   colors: ['#b76e79', '#f7e7ce', '#d4af37']
 });
 
 openedStars.add(i);
 
 if(openedStars.size === 5){
   document.getElementById('star-hint').innerText = "‚ú® All memories unlocked‚Ä¶ lets celebrate !!!! üíñ";
   setTimeout(() => nextStep(4), 1800);
 }
}

function handleModalTouch(e) {
  if(e.target === memoryModal) {
    closeMemory();
  }
}

function handleCloseTouch(e) {
  e.preventDefault();
  closeMemory();
}

function closeMemory(){ 
  memoryModal.style.display = "none"; 
}

function createSparkle(x, y){
  const sparkleCount = isMobile ? 4 : 6;
  for(let i = 0; i < sparkleCount; i++) {
    const s = document.createElement("div");
    s.className = "sparkle";
    s.style.left = (x + (Math.random() - 0.5) * 30) + "px";
    s.style.top = (y + (Math.random() - 0.5) * 30) + "px";
    s.style.animationDelay = (i * 0.08) + "s";
    document.body.appendChild(s);
    setTimeout(() => s.remove(), 900);
  }
}

// Mobile-optimized dodge function
function handleButtonTouch(e) {
  if(!buttonDodging) return;
  
  e.preventDefault();
  const btn = e.currentTarget;
  const touch = e.touches[0];
  
  if(navigator.vibrate) navigator.vibrate(15);
  
  // Sparkles
  for(let i = 0; i < 8; i++){
    createSparkle(
      touch.clientX + (Math.random() - 0.5) * 50,
      touch.clientY + (Math.random() - 0.5) * 50
    );
  }

  if(dodgeCount < 3){ // Reduced attempts for mobile
    const container = document.getElementById('step4');
    const containerRect = container.getBoundingClientRect();
    const btnRect = btn.getBoundingClientRect();
    
    // Calculate safe dodge area
    const maxX = containerRect.width - btnRect.width - 40;
    const maxY = containerRect.height - btnRect.height - 100;
    
    const randomX = (Math.random() - 0.5) * Math.min(200, maxX);
    const randomY = (Math.random() - 0.5) * Math.min(150, maxY);
    
    btn.style.transform = `translate(${randomX}px, ${randomY}px) rotate(${(Math.random() - 0.5) * 20}deg)`;
    dodgeCount++;
  } else {
    captureButton(btn);
  }
}

function handleButtonClick(e) {
  if(!buttonDodging) {
    celebrate();
  }
}

function captureButton(btn) {
  buttonDodging = false;
  btn.ontouchstart = null;
  btn.style.transform = "translate(0, 0) rotate(0deg)";
  btn.innerText = "You caught me, darling! üíñ";
  btn.style.background = "linear-gradient(135deg, var(--rose-gold), var(--gold))";
  btn.style.color = "white";
  document.getElementById('catch-msg').innerText = "My heart is yours forever‚Ä¶";

  if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);

  // Confetti burst
  confetti({
    particleCount: isMobile ? 80 : 120,
    spread: 100,
    origin: { y: 0.6 },
    colors: ['#b76e79', '#f7e7ce', '#d4af37']
  });

  setTimeout(() => celebrate(), 1200);
}

let celebrated = false;

function celebrate(){
  if(celebrated) return;
  celebrated = true;

  // Try to play music
  document.getElementById('bg-music').play().catch(e => {
    console.log('Audio autoplay blocked - user interaction needed');
  });
  
  // Epic confetti
  confetti({ 
    particleCount: isMobile ? 100 : 150, 
    spread: 120, 
    origin: { y: 0.6 },
    colors: ['#b76e79', '#f7e7ce', '#d4af37', '#e8b4b8']
  });
  
  setTimeout(() => {
    confetti({ 
      particleCount: isMobile ? 60 : 80, 
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#b76e79', '#f7e7ce', '#d4af37']
    });
    confetti({ 
      particleCount: isMobile ? 60 : 80, 
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#b76e79', '#f7e7ce', '#d4af37']
    });
  }, 250);

  setTimeout(() => nextStep(5), 1200);
}

function replayQuest() {
  openedStars.clear();
  dodgeCount = 0;
  buttonDodging = true;
  celebrated = false;
  
  document.getElementById('final-btn').innerText = "Catch Me ‚ù§Ô∏è";
  document.getElementById('final-btn').style.background = "linear-gradient(135deg, var(--champagne), var(--rose-gold))";
  document.getElementById('final-btn').style.color = "var(--deep-rose)";
  document.getElementById('final-btn').ontouchstart = handleButtonTouch;
  document.getElementById('catch-msg').innerText = "";
  document.getElementById('star-hint').innerText = "Open every star to start the celebrations‚Ä¶";
  
  document.querySelector('input[type="range"]').value = 1;
  updateSlider(1);
  
  nextStep(1);
}

// Add fadeSlideOut animation
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeSlideOut {
    from {
      opacity: 1;
      transform: translate3d(0, 0, 0) scale(1);
    }
    to {
      opacity: 0;
      transform: translate3d(0, -30px, 0) scale(0.95);
    }
  }
`;
document.head.appendChild(style);

// Prevent zoom on double tap
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Prevent pull to refresh
document.body.addEventListener('touchmove', function(e) {
  if(e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

</script>

</body>
</html>
